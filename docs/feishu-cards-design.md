# é£ä¹¦æ¶ˆæ¯å¡ç‰‡ç¾åŒ–è®¾è®¡æ–¹æ¡ˆ

## æ¦‚è¿°

ä¸º OKbot é£ä¹¦é›†æˆè®¾è®¡äº†ä¸€å¥—å®Œæ•´çš„äº¤äº’å¼å¡ç‰‡ç³»ç»Ÿï¼Œç”¨äºç¾åŒ–å’Œç»“æ„åŒ–å‘é€ç»™é£ä¹¦çš„æ¶ˆæ¯ã€‚ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼ˆæ€è€ƒè¿‡ç¨‹ã€å·¥å…·è°ƒç”¨ã€å·¥å…·ç»“æœã€æœç´¢ç»“æœï¼‰é‡‡ç”¨ä¸åŒçš„å¡ç‰‡æ ·å¼ï¼Œæå‡å¯è¯»æ€§å’Œç”¨æˆ·ä½“éªŒã€‚

## æ–‡ä»¶ç»“æ„

```
src/kimi_cli/feishu/
â”œâ”€â”€ card_builder.py      # å¡ç‰‡æ„å»ºå™¨ - ç”Ÿæˆé£ä¹¦å¡ç‰‡ JSON
â”œâ”€â”€ message_renderer.py  # æ¶ˆæ¯æ¸²æŸ“å™¨ - å°† Wire æ¶ˆæ¯è½¬æ¢ä¸ºå¡ç‰‡
â””â”€â”€ sdk_server.py        # å·²é›†æˆå¡ç‰‡å‘é€åŠŸèƒ½
```

## å¡ç‰‡ç±»å‹

### 1. ğŸ§  Thought å¡ç‰‡ï¼ˆæ€è€ƒè¿‡ç¨‹ï¼‰

**ç”¨é€”**: å±•ç¤º AI çš„æ€è€ƒè¿‡ç¨‹

**æ ·å¼**:
- ç°è‰²ä¸»é¢˜ (#F5F5F5)
- å¯æŠ˜å ï¼ˆå†…å®¹è¿‡é•¿æ—¶è‡ªåŠ¨æŠ˜å ï¼‰
-  brain_outlined å›¾æ ‡

**ç¤ºä¾‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ§  æ€è€ƒè¿‡ç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æˆ‘éœ€è¦æœç´¢å…³äº Python å¼‚æ­¥ç¼–ç¨‹...     â”‚
â”‚ [å±•å¼€å®Œæ•´æ€è€ƒ]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ğŸ”§ Tool Call å¡ç‰‡ï¼ˆå·¥å…·è°ƒç”¨ï¼‰

**ç”¨é€”**: å±•ç¤ºå‡½æ•°/å·¥å…·è°ƒç”¨ä¿¡æ¯

**æ ·å¼**:
- è“è‰²ä¸»é¢˜ (#3370FF)
- ä»£ç å—å±•ç¤ºå‚æ•°
- tool_outlined å›¾æ ‡

**ç¤ºä¾‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ è°ƒç”¨å·¥å…·: web_search              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ å‚æ•°:                             â”‚
â”‚ ```json                              â”‚
â”‚ {                                    â”‚
â”‚   "query": "Python asyncio"          â”‚
â”‚ }                                    â”‚
â”‚ ```                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. âœ… Tool Result å¡ç‰‡ï¼ˆå·¥å…·ç»“æœï¼‰

**ç”¨é€”**: å±•ç¤ºå·¥å…·æ‰§è¡Œç»“æœ

**æ ·å¼**:
- æˆåŠŸ: ç»¿è‰²ä¸»é¢˜ (#34D399)
- å¤±è´¥: çº¢è‰²ä¸»é¢˜ (#F87171)
- æ˜¾ç¤ºæ‰§è¡Œæ—¶é—´
- æ”¯æŒé•¿å†…å®¹æŠ˜å 

**ç¤ºä¾‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… æ‰§è¡ŒæˆåŠŸ - web_search (1.23s)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ‰¾åˆ° 5 æ¡ç»“æœ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. ğŸ” Search Result å¡ç‰‡ï¼ˆæœç´¢ç»“æœï¼‰

**ç”¨é€”**: å±•ç¤ºç½‘é¡µ/æ–‡ä»¶æœç´¢ç»“æœ

**æ ·å¼**:
- ç´«è‰²ä¸»é¢˜ (#A855F7)
- ç»“æ„åŒ–åˆ—è¡¨å±•ç¤º
- æ¯æ¡ç»“æœåŒ…å«æ ‡é¢˜ã€URLã€æ‘˜è¦
- æ”¯æŒ Markdown é“¾æ¥

**ç¤ºä¾‹**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” ç½‘é¡µæœç´¢ - å…± 10 æ¡                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” æŸ¥è¯¢: Python asyncio              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. [Python å®˜æ–¹æ–‡æ¡£](https://...)     â”‚
â”‚    Async IO is a library...          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ 2. [Python æ•™ç¨‹](https://...)         â”‚
â”‚    å­¦ä¹ å¦‚ä½•ä½¿ç”¨ asyncio...           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5. ğŸ’¬ Response å¡ç‰‡ï¼ˆå›å¤å†…å®¹ï¼‰

**ç”¨é€”**: å±•ç¤º AI çš„æ­£å¸¸å›å¤

**æ ·å¼**:
- é»˜è®¤ç™½è‰²ä¸»é¢˜
- æ”¯æŒ Markdown æ ¼å¼
- å®½å±æ¨¡å¼å±•ç¤º

### 6. âŒ Error å¡ç‰‡ï¼ˆé”™è¯¯æç¤ºï¼‰

**ç”¨é€”**: å±•ç¤ºé”™è¯¯ä¿¡æ¯

**æ ·å¼**:
- çº¢è‰²ä¸»é¢˜ (#F87171)
- error_outlined å›¾æ ‡
- å¯åŒ…å«ä¿®å¤å»ºè®®

## é¢œè‰²æ–¹æ¡ˆ

| ç±»å‹ | èƒŒæ™¯è‰² | è¾¹æ¡†è‰² | æ–‡å­—è‰² | å›¾æ ‡ |
|------|--------|--------|--------|------|
| Thought | #F5F5F5 | #9CA3AF | #6B7280 | ğŸ§  |
| Tool Call | #E8F1FF | #3370FF | #3370FF | ğŸ”§ |
| Tool Result (æˆåŠŸ) | #E8F8F0 | #34D399 | #059669 | âœ… |
| Tool Result (å¤±è´¥) | #FEE2E2 | #F87171 | #DC2626 | âŒ |
| Search Result | #F3E8FF | #A855F7 | #7C3AED | ğŸ” |
| Error | #FEE2E2 | #F87171 | #DC2626 | âŒ |
| Status | #FFF3E0 | #FB923C | #EA580C | â³ |

## ä½¿ç”¨æ–¹å¼

### åœ¨ SDKChatSession ä¸­

å¡ç‰‡æ¸²æŸ“å™¨å·²è‡ªåŠ¨é›†æˆåˆ° `SDKChatSession` ä¸­ï¼š

```python
# åœ¨ __init__ ä¸­åˆå§‹åŒ–
self._renderer = create_renderer()

# åœ¨ _wire_loop_text_parts ä¸­ä½¿ç”¨
async def send_thinking():
    card = self._renderer.render_thought(content)
    await asyncio.to_thread(
        self.client.send_interactive_card,
        self.chat_id,
        card,
    )
```

### ç›´æ¥ä½¿ç”¨å¡ç‰‡æ„å»ºå™¨

```python
from kimi_cli.feishu.card_builder import (
    build_thought_card,
    build_tool_call_card,
    build_tool_result_card,
    build_search_result_card,
)

# æ€è€ƒå¡ç‰‡
card = build_thought_card("æ€è€ƒå†…å®¹...", is_collapsed=True)

# å·¥å…·è°ƒç”¨å¡ç‰‡
card = build_tool_call_card(
    tool_name="web_search",
    arguments={"query": "Python"},
)

# å·¥å…·ç»“æœå¡ç‰‡
card = build_tool_result_card(
    tool_name="web_search",
    result={"results": [...]},
    is_error=False,
    execution_time=1.23,
)

# æœç´¢ç»“æœå¡ç‰‡
card = build_search_result_card(
    query="Python",
    results=[
        {"title": "...", "url": "...", "snippet": "..."},
    ],
    total_count=10,
    search_type="web",
)
```

## æ¶ˆæ¯æ¸²æŸ“å™¨

`MessageRenderer` ç±»è‡ªåŠ¨å¤„ç† Wire æ¶ˆæ¯çš„è½¬æ¢ï¼š

```python
renderer = create_renderer()

# æ¸²æŸ“æ€è€ƒ
card = renderer.render_think_part(think_part)

# æ¸²æŸ“å·¥å…·è°ƒç”¨
card = renderer.render_tool_call(tool_call)

# æ¸²æŸ“å·¥å…·ç»“æœï¼ˆè‡ªåŠ¨è¯†åˆ«æœç´¢ç»“æœï¼‰
card = renderer.render_tool_result(tool_call_id, result, tool_name)

# æ¸²æŸ“æ–‡æœ¬å“åº”
card = renderer.render_text_response(text)

# æ¸²æŸ“é”™è¯¯
card = renderer.render_error("é”™è¯¯ä¿¡æ¯", "Error", "å»ºè®®...")
```

## ç‰¹æ€§

1. **è‡ªåŠ¨ç±»å‹è¯†åˆ«**: æ¶ˆæ¯æ¸²æŸ“å™¨è‡ªåŠ¨è¯†åˆ«æœç´¢ç»“æœå¹¶åº”ç”¨ä¸“ç”¨å¡ç‰‡
2. **å†…å®¹æˆªæ–­**: é•¿å†…å®¹è‡ªåŠ¨æˆªæ–­ï¼Œé¿å…è¶…å‡ºé£ä¹¦é™åˆ¶
3. **æ‰§è¡Œæ—¶é—´è¿½è¸ª**: å·¥å…·è°ƒç”¨è‡ªåŠ¨è¿½è¸ªæ‰§è¡Œæ—¶é—´
4. **é”™è¯¯å›é€€**: å¡ç‰‡å‘é€å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æ–‡æœ¬æ¶ˆæ¯
5. **å¯Œæ–‡æœ¬æ”¯æŒ**: æ”¯æŒ Markdown æ ¼å¼å’Œä»£ç å—

## æ‰©å±•

å¦‚éœ€æ·»åŠ æ–°çš„å¡ç‰‡ç±»å‹ï¼š

1. åœ¨ `card_builder.py` ä¸­å®ç°æ–°çš„æ„å»ºå‡½æ•°
2. åœ¨ `message_renderer.py` ä¸­æ·»åŠ å¯¹åº”çš„æ¸²æŸ“æ–¹æ³•
3. åœ¨ `sdk_server.py` çš„ `_wire_loop_text_parts` ä¸­è°ƒç”¨

## å‚è€ƒ

- [é£ä¹¦å¡ç‰‡æ¶ˆæ¯æ–‡æ¡£](https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/feishu-cards/card-overview)
- å¡ç‰‡ Schema ç‰ˆæœ¬: 2.0
