# OKBot ä¸Šæ¸¸åŒæ­¥çŠ¶æ€æŠ¥å‘Š

## ğŸ“Š åŒæ­¥æ¦‚è§ˆ

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **æºåˆ†æ”¯** | âœ… å®Œæˆ | `main` (cba3a3f) |
| **ç›®æ ‡åˆ†æ”¯** | âœ… å®Œæˆ | `upstream/main` (9349804) |
| **åˆå¹¶åˆ†æ”¯** | âœ… å®Œæˆ | `feat/sync-upstream-1.9.0` (ef42890) |
| **å†²çªè§£å†³** | âœ… å®Œæˆ | pyproject.toml, uv.lock |

## ğŸ”„ ä¸Šæ¸¸å˜æ›´åˆå¹¶æƒ…å†µ

### å·²åˆå¹¶çš„ä¸Šæ¸¸åŠŸèƒ½

| æäº¤ | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| `9349804` | Mobile prompt input UX æ”¹è¿› | âœ… å·²åˆå¹¶ |
| `44adae9` | kimi-cli 1.9.0, kosong 0.42.0, pykaos 0.7.0 | âœ… å·²åˆå¹¶ |
| `34e5a6e` | `default_yolo` é…ç½®é€‰é¡¹ | âœ… å·²åˆå¹¶ |
| `7dcc52d` | Archive æ”¯æŒ | âœ… å·²åˆå¹¶ |
| `394bd99` | Session fork | âœ… å·²åˆå¹¶ |
| `0d59289` | Replay endpoint | âœ… å·²åˆå¹¶ |
| `6050a31` | Session ID ä¿ç•™ & replay history æ¸…ç† | âœ… å·²åˆå¹¶ |
| `c6e4e15` | Auto scroll ä¼˜åŒ– | âœ… å·²åˆå¹¶ |
| `c467d26` | Tool input UI é‡è®¾è®¡ | âœ… å·²åˆå¹¶ |

### ä¿ç•™çš„ OKBot ç‰¹æœ‰åŠŸèƒ½

| åŠŸèƒ½ | æ–‡ä»¶ | çŠ¶æ€ |
|------|------|------|
| **MCP å·¥å…·éš”ç¦»** (`{server}__`) | `src/kimi_cli/soul/toolset.py` | âœ… ä¿ç•™ |
| **MCP çƒ­æ›´æ–°** (`/update-mcp`) | `src/kimi_cli/soul/toolset.py` | âœ… ä¿ç•™ |
| **Skills çƒ­æ›´æ–°** (`/update-skill`) | `src/kimi_cli/soul/kimisoul.py` | âœ… ä¿ç•™ |
| **YOLO å¼ºåˆ¶å¼€å¯** | `src/kimi_cli/feishu/sdk_server.py` | âœ… ä¿ç•™ |
| **é£ä¹¦æ·±åº¦é›†æˆ** | `src/kimi_cli/feishu/` | âœ… ä¿ç•™ |
| **è·¨ç«¯ Session æ¥ç»­** | `/sessions`, `/continue`, `/id` | âœ… ä¿ç•™ |

## ğŸ§ª æµ‹è¯•è¦†ç›–

### å·²åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶

```
tests/okbot/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ test_mcp_hot_reload.py      # MCP/Skills çƒ­æ›´æ–°æµ‹è¯•
â”œâ”€â”€ test_feishu_integration.py  # é£ä¹¦é›†æˆæµ‹è¯•
â””â”€â”€ test_approval_card.py       # æˆæƒå¡ç‰‡æµ‹è¯•
```

### æµ‹è¯•è¦†ç›–èŒƒå›´

| æ¨¡å— | æµ‹è¯•ç”¨ä¾‹æ•° | è¦†ç›–åŠŸèƒ½ |
|------|-----------|---------|
| MCP çƒ­æ›´æ–° | 4 | reload_mcp_tools, å·¥å…·éš”ç¦» |
| Skills çƒ­æ›´æ–° | 2 | reload_skills, system prompt æ›´æ–° |
| Slash å‘½ä»¤ | 2 | /update-mcp, /update-skill |
| é£ä¹¦é›†æˆ | 5 | ğŸ‘Œ åé¦ˆ, YOLO å¼ºåˆ¶, Session æ¥ç»­ |
| æˆæƒå¡ç‰‡ | 6 | approve, approve_for_session, reject |

## ğŸ†• æ–°å¢åŠŸèƒ½ï¼šæˆæƒå¡ç‰‡æœºåˆ¶

### åŠŸèƒ½è®¾è®¡

å½“ YOLO æ¨¡å¼å…³é—­æ—¶ï¼Œå·¥å…·è°ƒç”¨éœ€è¦é€šè¿‡é£ä¹¦å¡ç‰‡è¯·æ±‚ç”¨æˆ·æˆæƒï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ éœ€è¦æˆæƒ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å·¥å…·: Shell__execute                â”‚
â”‚ æ“ä½œ: æ‰§è¡Œå‘½ä»¤: rm -rf /important   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¯·é€‰æ‹©æ“ä½œï¼š                         â”‚
â”‚                                     â”‚
â”‚ [âœ… å…è®¸ä¸€æ¬¡] [ğŸ”“ å§‹ç»ˆå…è®¸] [âŒ æ‹’ç»] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¡ æç¤º: YOLO æ¨¡å¼ä¸‹è‡ªåŠ¨æ‰¹å‡†æ‰€æœ‰æ“ä½œ  â”‚
â”‚    å‘é€ /yolo åˆ‡æ¢æ¨¡å¼              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·²å®ç°ä»£ç 

1. **æˆæƒå¡ç‰‡æ„å»ºå™¨** (`src/kimi_cli/feishu/card_builder.py`)
   - `build_approval_card()` - åˆ›å»ºæˆæƒè¯·æ±‚å¡ç‰‡
   - `build_approval_result_card()` - åˆ›å»ºæˆæƒç»“æœå¡ç‰‡

2. **å®¡æ‰¹çŠ¶æ€ç®¡ç†** (`src/kimi_cli/soul/approval.py`)
   - å·²æ”¯æŒä¸‰ç§å“åº”ç±»å‹ï¼š
     - `approve` - å•æ¬¡å…è®¸
     - `approve_for_session` - æ­¤å¯¹è¯å…è®¸
     - `reject` - æ‹’ç»

### å¾…å®Œæˆå·¥ä½œ

è¦å®Œæˆæˆæƒå¡ç‰‡åŠŸèƒ½ï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹æ–‡ä»¶ï¼š

#### 1. `src/kimi_cli/feishu/sdk_server.py`

ä¿®æ”¹ `SDKMessageHandler._wire_loop()` ä¸­çš„ `ApprovalRequest` å¤„ç†é€»è¾‘ï¼š

```python
# å½“å‰ä»£ç  (YOLO æ¨¡å¼)
elif isinstance(msg, ApprovalRequest):
    # YOLO mode: auto approve all tool calls
    msg.resolve("approve")

# éœ€è¦æ”¹ä¸ºï¼š
elif isinstance(msg, ApprovalRequest):
    if self.yolo_mode:
        msg.resolve("approve")
    else:
        # å‘é€æˆæƒå¡ç‰‡å¹¶ç­‰å¾…ç”¨æˆ·å“åº”
        await self._send_approval_card(msg)
```

éœ€è¦æ·»åŠ ï¼š
- `_pending_approvals: dict[str, ApprovalRequest]` - å­˜å‚¨å¾…å¤„ç†çš„å®¡æ‰¹è¯·æ±‚
- `_send_approval_card()` - å‘é€æˆæƒå¡ç‰‡
- `_handle_card_callback()` - å¤„ç†å¡ç‰‡æŒ‰é’®å›è°ƒ

#### 2. å¡ç‰‡å›è°ƒå¤„ç†

éœ€è¦å®ç°é£ä¹¦å¡ç‰‡å›è°ƒçš„å¤„ç†é€»è¾‘ï¼Œå½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ï¼š
1. è§£æå›è°ƒæ•°æ®è·å– `request_id` å’Œ `action`
2. æŸ¥æ‰¾å¯¹åº”çš„ `ApprovalRequest`
3. æ ¹æ®ç”¨æˆ·é€‰æ‹©è°ƒç”¨ `msg.resolve()`

## ğŸ“ ç‰ˆæœ¬ä¿¡æ¯

```toml
[project]
name = "kimi-cli"
version = "1.9.0"  # ä¸Šæ¸¸ç‰ˆæœ¬
# å®é™…ä¸º OKBot 1.9.0 (åŸºäºä¸Šæ¸¸ 1.9.0 + OKBot ç‰¹æ€§)

dependencies = [
    "kosong[contrib]==0.42.0",  # ä¸Šæ¸¸å‡çº§
    "pykaos==0.7.0",            # ä¸Šæ¸¸å‡çº§
    # ... å…¶ä»–ä¾èµ–
]
```

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ

1. **å®Œæˆæˆæƒå¡ç‰‡é›†æˆ**
   - ä¿®æ”¹ `sdk_server.py` å¤„ç†é YOLO æ¨¡å¼çš„å®¡æ‰¹è¯·æ±‚
   - å®ç°å¡ç‰‡å›è°ƒå¤„ç†
   - æ·»åŠ ç”¨æˆ·æŒ‡å—

2. **è¿è¡Œå®Œæ•´æµ‹è¯•**
   ```bash
   uv run pytest tests/okbot/ -v
   ```

3. **éªŒè¯åŠŸèƒ½å®Œæ•´æ€§**
   - æµ‹è¯• MCP çƒ­æ›´æ–°
   - æµ‹è¯• Skills çƒ­æ›´æ–°
   - æµ‹è¯•è·¨ç«¯ Session æ¥ç»­
   - æµ‹è¯•æˆæƒå¡ç‰‡ï¼ˆå¼€å‘å®Œæˆåï¼‰

### é•¿æœŸä¼˜åŒ–

1. **æ€§èƒ½ä¼˜åŒ–**
   - å¡ç‰‡æ›´æ–°æ€§èƒ½
   - å¤§æ¶ˆæ¯å¤„ç†

2. **åŠŸèƒ½å¢å¼º**
   - æ›´å¤šå¡ç‰‡ç±»å‹
   - æ›´ä¸°å¯Œçš„äº¤äº’

## ğŸ› å·²çŸ¥é—®é¢˜

| é—®é¢˜ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| uv sync ç¼–è¯‘é”™è¯¯ | âš ï¸ ç¯å¢ƒç›¸å…³ | `google-re2` ç¼–è¯‘å¤±è´¥ï¼Œä¸å½±å“ä»£ç é€»è¾‘ |
| æˆæƒå¡ç‰‡å¾…å®Œæˆ | ğŸš§ å¼€å‘ä¸­ | åŸºç¡€ä»£ç å·²å°±ç»ªï¼Œéœ€è¦é›†æˆåˆ° sdk_server |

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [ä¸Šæ¸¸ Changelog](CHANGELOG.md)
- [é£ä¹¦å¡ç‰‡æ–‡æ¡£](https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/feishu-cards/card-overview)
- [OKBot README](README.md)
